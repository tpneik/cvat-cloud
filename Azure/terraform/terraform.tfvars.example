# Azure Subscription Configuration
subscription_id = "bb79d671-6949-4663-854e-14424d667454"

# Application Configuration
application_name = "cvat"
client_name      = "kienpt"
location         = "East Asia"

# Network Configuration
# Leave null to use auto-generated names based on client_name and application_name
# resource_group_name                     = null
# virtual_network_name                    = null
# application_subnet_name                 = null
# database_subnet_name                    = null
# traefik_application_gateway_subnet      = null
# Azure Subscription Configuration
subscription_id = "bb79d671-6949-4663-854e-14424d667454"

# Application Configuration
application_name = "cvat"
client_name      = "kienpt"
location         = "East Asia"

# Network Configuration
# Leave null to use auto-generated names based on client_name and application_name
# resource_group_name                     = null
# virtual_network_name                    = null
# application_subnet_name                 = null
# database_subnet_name                    = null
# traefik_application_gateway_subnet      = null

# Container App Environment Configuration

container_apps = {

    cvat_clickhouse = {
        name          = "cvat-clickhouse"
        revision_mode = "Single"

        template = {
            containers = [
                {
                    name   = "cvat-clickhouse"
                    image  = "docker.io/clickhouse/clickhouse-server:23.11-alpine"
                    cpu    = "0.5"
                    memory = "1Gi"
                    
                    env = [
                        {
                            name        = "CLICKHOUSE_HOST"
                            value       = "cvat-clickhouse"
                        },
                        {
                            name        = "CLICKHOUSE_PORT"
                            value       = "8123"
                        },
                        {
                            name        = "CLICKHOUSE_DB"
                            value       = "cvat"
                        },
                        {
                            name        = "CLICKHOUSE_USER"
                            value       = "user"
                        },
                        {
                            name        = "CLICKHOUSE_PASSWORD"
                            value       = "user"
                        }
                    ]

                    # liveness_probe = {
                    #     port      = 8080
                    #     path      = "/api/server/health"
                    #     transport = "HTTP"
                    #     initial_delay = 30
                    #     interval_seconds = 10
                    # }
                }
            ]
            
            min_replicas = 1
            max_replicas = 1
        }

        ingress = {
            target_port         = 8123
            transport           = "tcp"
            
            traffic_weight = {
                latest_revision = true
                percentage      = 100
            }
        }
    }

    # Second container app - Redis
    # redis_inmem = {
    #     name          = "cvat-redis-inmem"
    #     revision_mode = "Single"

    #     template = {
    #     containers = [
    #         {
    #         name   = "redis"
    #         image  = "redis:7.0-alpine"
    #         cpu    = "0.5"
    #         memory = "1Gi"
            
    #         args = ["redis-server", "--maxmemory", "512mb"]
    #         }
    #     ]
        
    #     min_replicas = 1
    #     max_replicas = 1
    #     }

    #     ingress = {
    #     external_enabled = false
    #     target_port      = 6379
        
    #     traffic_weight = {
    #         percentage = 100
    #     }
    #     }
    # }

  # Third container app - Clickhouse with volumes
    # clickhouse = {
    #     name          = "cvat-clickhouse"
    #     revision_mode = "Single"

    #     template = {
    #     containers = [
    #         {
    #         name   = "clickhouse"
    #         image  = "clickhouse/clickhouse-server:23.11-alpine"
    #         cpu    = "1.0"
    #         memory = "2Gi"
            
    #         volume_mounts = [
    #             {
    #             name = "clickhouse-data"
    #             path = "/var/lib/clickhouse"
    #             }
    #         ]
    #         }
    #     ]
        
    #     min_replicas = 1
    #     max_replicas = 1
        
    #     volume = [
    #         {
    #         name         = "clickhouse-data"
    #         storage_type = "AzureFile"
    #         storage_name = "clickhouse-storage"
    #         }
    #     ]
    #     }
    # }
}